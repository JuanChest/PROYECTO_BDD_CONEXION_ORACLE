-- FRAGMENTOS EN NODO2

-- 1. PROVINCIA (fragmentos)
CREATE TABLE PROVINCIA_GUAYAS AS SELECT * FROM PROVINCIA WHERE NOMBRE_PROVINCIA = 'Guayas' WITH NO DATA;
CREATE TABLE PROVINCIA_MANABI AS SELECT * FROM PROVINCIA WHERE NOMBRE_PROVINCIA = 'Manabí' WITH NO DATA;
CREATE TABLE PROVINCIA_ESMERALDAS AS SELECT * FROM PROVINCIA WHERE NOMBRE_PROVINCIA = 'Esmeraldas' WITH NO DATA;

ALTER TABLE PROVINCIA_GUAYAS ADD CONSTRAINT PROVINCIA_GUAYAS_PK PRIMARY KEY (PROVINCIA_ID);
ALTER TABLE PROVINCIA_MANABI ADD CONSTRAINT PROVINCIA_MANABI_PK PRIMARY KEY (PROVINCIA_ID);
ALTER TABLE PROVINCIA_ESMERALDAS ADD CONSTRAINT PROVINCIA_ESMERALDAS_PK PRIMARY KEY (PROVINCIA_ID);

ALTER TABLE PROVINCIA_GUAYAS ADD CONSTRAINT PROVINCIA_GUAYAS_CK CHECK (NOMBRE_PROVINCIA = 'Guayas');
ALTER TABLE PROVINCIA_MANABI ADD CONSTRAINT PROVINCIA_MANABI_CK CHECK (NOMBRE_PROVINCIA = 'Manabí');
ALTER TABLE PROVINCIA_ESMERALDAS ADD CONSTRAINT PROVINCIA_ESMERALDAS_CK CHECK (NOMBRE_PROVINCIA = 'Esmeraldas');

-- 2. TIENDA (fragmentos)
CREATE TABLE TIENDA_GUAYAS AS SELECT * FROM TIENDA WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_GUAYAS) WITH NO DATA;
CREATE TABLE TIENDA_MANABI AS SELECT * FROM TIENDA WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_MANABI) WITH NO DATA;
CREATE TABLE TIENDA_ESMERALDAS AS SELECT * FROM TIENDA WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_ESMERALDAS) WITH NO DATA;

ALTER TABLE TIENDA_GUAYAS ADD CONSTRAINT TIENDA_GUAYAS_PK PRIMARY KEY (ID_TIENDA);
ALTER TABLE TIENDA_MANABI ADD CONSTRAINT TIENDA_MANABI_PK PRIMARY KEY (ID_TIENDA);
ALTER TABLE TIENDA_ESMERALDAS ADD CONSTRAINT TIENDA_ESMERALDAS_PK PRIMARY KEY (ID_TIENDA);

ALTER TABLE TIENDA_GUAYAS ADD CONSTRAINT TIENDA_GUAYAS_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_GUAYAS(PROVINCIA_ID);
ALTER TABLE TIENDA_MANABI ADD CONSTRAINT TIENDA_MANABI_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_MANABI(PROVINCIA_ID);
ALTER TABLE TIENDA_ESMERALDAS ADD CONSTRAINT TIENDA_ESMERALDAS_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_ESMERALDAS(PROVINCIA_ID);

ALTER TABLE TIENDA_GUAYAS ADD CONSTRAINT TIENDA_GUAYAS_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_GUAYAS));
ALTER TABLE TIENDA_MANABI ADD CONSTRAINT TIENDA_MANABI_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_MANABI));
ALTER TABLE TIENDA_ESMERALDAS ADD CONSTRAINT TIENDA_ESMERALDAS_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_ESMERALDAS));

-- 3. CLIENTE (fragmentos)
CREATE TABLE CLIENTE_GUAYAS AS SELECT * FROM CLIENTE WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_GUAYAS) WITH NO DATA;
CREATE TABLE CLIENTE_MANABI AS SELECT * FROM CLIENTE WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_MANABI) WITH NO DATA;
CREATE TABLE CLIENTE_ESMERALDAS AS SELECT * FROM CLIENTE WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_ESMERALDAS) WITH NO DATA;

ALTER TABLE CLIENTE_GUAYAS ADD CONSTRAINT CLIENTE_GUAYAS_PK PRIMARY KEY (CLIENTE_ID);
ALTER TABLE CLIENTE_MANABI ADD CONSTRAINT CLIENTE_MANABI_PK PRIMARY KEY (CLIENTE_ID);
ALTER TABLE CLIENTE_ESMERALDAS ADD CONSTRAINT CLIENTE_ESMERALDAS_PK PRIMARY KEY (CLIENTE_ID);

ALTER TABLE CLIENTE_GUAYAS ADD CONSTRAINT CLIENTE_GUAYAS_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_GUAYAS(PROVINCIA_ID);
ALTER TABLE CLIENTE_MANABI ADD CONSTRAINT CLIENTE_MANABI_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_MANABI(PROVINCIA_ID);
ALTER TABLE CLIENTE_ESMERALDAS ADD CONSTRAINT CLIENTE_ESMERALDAS_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_ESMERALDAS(PROVINCIA_ID);

ALTER TABLE CLIENTE_GUAYAS ADD CONSTRAINT CLIENTE_GUAYAS_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_GUAYAS));
ALTER TABLE CLIENTE_MANABI ADD CONSTRAINT CLIENTE_MANABI_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_MANABI));
ALTER TABLE CLIENTE_ESMERALDAS ADD CONSTRAINT CLIENTE_ESMERALDAS_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_ESMERALDAS));

-- 4. VENTAS (fragmentos)
CREATE TABLE VENTAS_GUAYAS AS SELECT * FROM VENTAS v JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_GUAYAS) WITH NO DATA;
CREATE TABLE VENTAS_MANABI AS SELECT * FROM VENTAS v JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_MANABI) WITH NO DATA;
CREATE TABLE VENTAS_ESMERALDAS AS SELECT * FROM VENTAS v JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_ESMERALDAS) WITH NO DATA;

ALTER TABLE VENTAS_GUAYAS ADD CONSTRAINT VENTAS_GUAYAS_PK PRIMARY KEY (VENTA_ID);
ALTER TABLE VENTAS_MANABI ADD CONSTRAINT VENTAS_MANABI_PK PRIMARY KEY (VENTA_ID);
ALTER TABLE VENTAS_ESMERALDAS ADD CONSTRAINT VENTAS_ESMERALDAS_PK PRIMARY KEY (VENTA_ID);

ALTER TABLE VENTAS_GUAYAS ADD CONSTRAINT VENTAS_GUAYAS_FK_CLIENTE FOREIGN KEY (CLIENTE_ID) REFERENCES CLIENTE_GUAYAS(CLIENTE_ID);
ALTER TABLE VENTAS_MANABI ADD CONSTRAINT VENTAS_MANABI_FK_CLIENTE FOREIGN KEY (CLIENTE_ID) REFERENCES CLIENTE_MANABI(CLIENTE_ID);
ALTER TABLE VENTAS_ESMERALDAS ADD CONSTRAINT VENTAS_ESMERALDAS_FK_CLIENTE FOREIGN KEY (CLIENTE_ID) REFERENCES CLIENTE_ESMERALDAS(CLIENTE_ID);

ALTER TABLE VENTAS_GUAYAS ADD CONSTRAINT VENTAS_GUAYAS_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_GUAYAS(ID_TIENDA);
ALTER TABLE VENTAS_MANABI ADD CONSTRAINT VENTAS_MANABI_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_MANABI(ID_TIENDA);
ALTER TABLE VENTAS_ESMERALDAS ADD CONSTRAINT VENTAS_ESMERALDAS_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_ESMERALDAS(ID_TIENDA);

ALTER TABLE VENTAS_GUAYAS ADD CONSTRAINT VENTAS_GUAYAS_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_GUAYAS));
ALTER TABLE VENTAS_MANABI ADD CONSTRAINT VENTAS_MANABI_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_MANABI));
ALTER TABLE VENTAS_ESMERALDAS ADD CONSTRAINT VENTAS_ESMERALDAS_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_ESMERALDAS));

-- 5. INVENTARIO (fragmentos)
CREATE TABLE INVENTARIO_GUAYAS AS SELECT * FROM INVENTARIO i JOIN TIENDA t ON i.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_GUAYAS) WITH NO DATA;
CREATE TABLE INVENTARIO_MANABI AS SELECT * FROM INVENTARIO i JOIN TIENDA t ON i.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_MANABI) WITH NO DATA;
CREATE TABLE INVENTARIO_ESMERALDAS AS SELECT * FROM INVENTARIO i JOIN TIENDA t ON i.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_ESMERALDAS) WITH NO DATA;

ALTER TABLE INVENTARIO_GUAYAS ADD CONSTRAINT INVENTARIO_GUAYAS_PK PRIMARY KEY (INVENTARIO_ID);
ALTER TABLE INVENTARIO_MANABI ADD CONSTRAINT INVENTARIO_MANABI_PK PRIMARY KEY (INVENTARIO_ID);
ALTER TABLE INVENTARIO_ESMERALDAS ADD CONSTRAINT INVENTARIO_ESMERALDAS_PK PRIMARY KEY (INVENTARIO_ID);

ALTER TABLE INVENTARIO_GUAYAS ADD CONSTRAINT INVENTARIO_GUAYAS_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_GUAYAS(ID_TIENDA);
ALTER TABLE INVENTARIO_MANABI ADD CONSTRAINT INVENTARIO_MANABI_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_MANABI(ID_TIENDA);
ALTER TABLE INVENTARIO_ESMERALDAS ADD CONSTRAINT INVENTARIO_ESMERALDAS_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_ESMERALDAS(ID_TIENDA);

ALTER TABLE INVENTARIO_GUAYAS ADD CONSTRAINT INVENTARIO_GUAYAS_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_GUAYAS));
ALTER TABLE INVENTARIO_MANABI ADD CONSTRAINT INVENTARIO_MANABI_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_MANABI));
ALTER TABLE INVENTARIO_ESMERALDAS ADD CONSTRAINT INVENTARIO_ESMERALDAS_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_ESMERALDAS));

-- 6. DETALLE_VENTA (fragmentos)
CREATE TABLE DETALLE_VENTA_GUAYAS AS 
SELECT dv.* 
FROM DETALLE_VENTA dv 
JOIN VENTAS v ON dv.VENTA_ID = v.VENTA_ID 
JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA 
WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_GUAYAS) WITH NO DATA;

CREATE TABLE DETALLE_VENTA_MANABI AS 
SELECT dv.* 
FROM DETALLE_VENTA dv 
JOIN VENTAS v ON dv.VENTA_ID = v.VENTA_ID 
JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA 
WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_MANABI) WITH NO DATA;

CREATE TABLE DETALLE_VENTA_ESMERALDAS AS 
SELECT dv.* 
FROM DETALLE_VENTA dv 
JOIN VENTAS v ON dv.VENTA_ID = v.VENTA_ID 
JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA 
WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_ESMERALDAS) WITH NO DATA;

ALTER TABLE DETALLE_VENTA_GUAYAS ADD CONSTRAINT DETALLE_VENTA_GUAYAS_PK PRIMARY KEY (VENTA_ID, DETALLE_ID);
ALTER TABLE DETALLE_VENTA_MANABI ADD CONSTRAINT DETALLE_VENTA_MANABI_PK PRIMARY KEY (VENTA_ID, DETALLE_ID);
ALTER TABLE DETALLE_VENTA_ESMERALDAS ADD CONSTRAINT DETALLE_VENTA_ESMERALDAS_PK PRIMARY KEY (VENTA_ID, DETALLE_ID);

ALTER TABLE DETALLE_VENTA_GUAYAS ADD CONSTRAINT DETALLE_VENTA_GUAYAS_FK_VENTAS FOREIGN KEY (VENTA_ID) REFERENCES VENTAS_GUAYAS(VENTA_ID);
ALTER TABLE DETALLE_VENTA_MANABI ADD CONSTRAINT DETALLE_VENTA_MANABI_FK_VENTAS FOREIGN KEY (VENTA_ID) REFERENCES VENTAS_MANABI(VENTA_ID);
ALTER TABLE DETALLE_VENTA_ESMERALDAS ADD CONSTRAINT DETALLE_VENTA_ESMERALDAS_FK_VENTAS FOREIGN KEY (VENTA_ID) REFERENCES VENTAS_ESMERALDAS(VENTA_ID);

ALTER TABLE DETALLE_VENTA_GUAYAS ADD CONSTRAINT DETALLE_VENTA_GUAYAS_FK_PRODUCTO FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTO(PRODUCTO_ID);
ALTER TABLE DETALLE_VENTA_MANABI ADD CONSTRAINT DETALLE_VENTA_MANABI_FK_PRODUCTO FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTO(PRODUCTO_ID);
ALTER TABLE DETALLE_VENTA_ESMERALDAS ADD CONSTRAINT DETALLE_VENTA_ESMERALDAS_FK_PRODUCTO FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTO(PRODUCTO_ID);

ALTER TABLE DETALLE_VENTA_GUAYAS ADD CONSTRAINT DETALLE_VENTA_GUAYAS_CK CHECK (VENTA_ID IN (SELECT VENTA_ID FROM VENTAS_GUAYAS));
ALTER TABLE DETALLE_VENTA_MANABI ADD CONSTRAINT DETALLE_VENTA_MANABI_CK CHECK (VENTA_ID IN (SELECT VENTA_ID FROM VENTAS_MANABI));
ALTER TABLE DETALLE_VENTA_ESMERALDAS ADD CONSTRAINT DETALLE_VENTA_ESMERALDAS_CK CHECK (VENTA_ID IN (SELECT VENTA_ID FROM VENTAS_ESMERALDAS));
