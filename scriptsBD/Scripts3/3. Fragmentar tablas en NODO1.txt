-- FRAGMENTOS EN NODO1

-- 1. PROVINCIA (fragmentos)
CREATE TABLE PROVINCIA_PICHINCHA AS SELECT * FROM PROVINCIA WHERE NOMBRE_PROVINCIA = 'Pichincha' WITH NO DATA;
CREATE TABLE PROVINCIA_COTOPAXI AS SELECT * FROM PROVINCIA WHERE NOMBRE_PROVINCIA = 'Cotopaxi' WITH NO DATA;
CREATE TABLE PROVINCIA_TUNGURAHUA AS SELECT * FROM PROVINCIA WHERE NOMBRE_PROVINCIA = 'Tungurahua' WITH NO DATA;

ALTER TABLE PROVINCIA_PICHINCHA ADD CONSTRAINT PROVINCIA_PICHINCHA_PK PRIMARY KEY (PROVINCIA_ID);
ALTER TABLE PROVINCIA_COTOPAXI ADD CONSTRAINT PROVINCIA_COTOPAXI_PK PRIMARY KEY (PROVINCIA_ID);
ALTER TABLE PROVINCIA_TUNGURAHUA ADD CONSTRAINT PROVINCIA_TUNGURAHUA_PK PRIMARY KEY (PROVINCIA_ID);

ALTER TABLE PROVINCIA_PICHINCHA ADD CONSTRAINT PROVINCIA_PICHINCHA_CK CHECK (NOMBRE_PROVINCIA = 'Pichincha');
ALTER TABLE PROVINCIA_COTOPAXI ADD CONSTRAINT PROVINCIA_COTOPAXI_CK CHECK (NOMBRE_PROVINCIA = 'Cotopaxi');
ALTER TABLE PROVINCIA_TUNGURAHUA ADD CONSTRAINT PROVINCIA_TUNGURAHUA_CK CHECK (NOMBRE_PROVINCIA = 'Tungurahua');

-- 2. TIENDA (fragmentos)
CREATE TABLE TIENDA_PICHINCHA AS SELECT * FROM TIENDA WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_PICHINCHA) WITH NO DATA;
CREATE TABLE TIENDA_COTOPAXI AS SELECT * FROM TIENDA WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_COTOPAXI) WITH NO DATA;
CREATE TABLE TIENDA_TUNGURAHUA AS SELECT * FROM TIENDA WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_TUNGURAHUA) WITH NO DATA;

ALTER TABLE TIENDA_PICHINCHA ADD CONSTRAINT TIENDA_PICHINCHA_PK PRIMARY KEY (ID_TIENDA);
ALTER TABLE TIENDA_COTOPAXI ADD CONSTRAINT TIENDA_COTOPAXI_PK PRIMARY KEY (ID_TIENDA);
ALTER TABLE TIENDA_TUNGURAHUA ADD CONSTRAINT TIENDA_TUNGURAHUA_PK PRIMARY KEY (ID_TIENDA);

ALTER TABLE TIENDA_PICHINCHA ADD CONSTRAINT TIENDA_PICHINCHA_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_PICHINCHA(PROVINCIA_ID);
ALTER TABLE TIENDA_COTOPAXI ADD CONSTRAINT TIENDA_COTOPAXI_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_COTOPAXI(PROVINCIA_ID);
ALTER TABLE TIENDA_TUNGURAHUA ADD CONSTRAINT TIENDA_TUNGURAHUA_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_TUNGURAHUA(PROVINCIA_ID);

ALTER TABLE TIENDA_PICHINCHA ADD CONSTRAINT TIENDA_PICHINCHA_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_PICHINCHA));
ALTER TABLE TIENDA_COTOPAXI ADD CONSTRAINT TIENDA_COTOPAXI_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_COTOPAXI));
ALTER TABLE TIENDA_TUNGURAHUA ADD CONSTRAINT TIENDA_TUNGURAHUA_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_TUNGURAHUA));

-- 3. CLIENTE (fragmentos)
CREATE TABLE CLIENTE_PICHINCHA AS SELECT * FROM CLIENTE WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_PICHINCHA) WITH NO DATA;
CREATE TABLE CLIENTE_COTOPAXI AS SELECT * FROM CLIENTE WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_COTOPAXI) WITH NO DATA;
CREATE TABLE CLIENTE_TUNGURAHUA AS SELECT * FROM CLIENTE WHERE PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_TUNGURAHUA) WITH NO DATA;

ALTER TABLE CLIENTE_PICHINCHA ADD CONSTRAINT CLIENTE_PICHINCHA_PK PRIMARY KEY (CLIENTE_ID);
ALTER TABLE CLIENTE_COTOPAXI ADD CONSTRAINT CLIENTE_COTOPAXI_PK PRIMARY KEY (CLIENTE_ID);
ALTER TABLE CLIENTE_TUNGURAHUA ADD CONSTRAINT CLIENTE_TUNGURAHUA_PK PRIMARY KEY (CLIENTE_ID);

ALTER TABLE CLIENTE_PICHINCHA ADD CONSTRAINT CLIENTE_PICHINCHA_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_PICHINCHA(PROVINCIA_ID);
ALTER TABLE CLIENTE_COTOPAXI ADD CONSTRAINT CLIENTE_COTOPAXI_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_COTOPAXI(PROVINCIA_ID);
ALTER TABLE CLIENTE_TUNGURAHUA ADD CONSTRAINT CLIENTE_TUNGURAHUA_FK_PROVINCIA FOREIGN KEY (PROVINCIA_ID) REFERENCES PROVINCIA_TUNGURAHUA(PROVINCIA_ID);

ALTER TABLE CLIENTE_PICHINCHA ADD CONSTRAINT CLIENTE_PICHINCHA_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_PICHINCHA));
ALTER TABLE CLIENTE_COTOPAXI ADD CONSTRAINT CLIENTE_COTOPAXI_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_COTOPAXI));
ALTER TABLE CLIENTE_TUNGURAHUA ADD CONSTRAINT CLIENTE_TUNGURAHUA_CK CHECK (PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_TUNGURAHUA));

-- 4. VENTAS (fragmentos)
CREATE TABLE VENTAS_PICHINCHA AS SELECT * FROM VENTAS v JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_PICHINCHA) WITH NO DATA;
CREATE TABLE VENTAS_COTOPAXI AS SELECT * FROM VENTAS v JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_COTOPAXI) WITH NO DATA;
CREATE TABLE VENTAS_TUNGURAHUA AS SELECT * FROM VENTAS v JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_TUNGURAHUA) WITH NO DATA;

ALTER TABLE VENTAS_PICHINCHA ADD CONSTRAINT VENTAS_PICHINCHA_PK PRIMARY KEY (VENTA_ID);
ALTER TABLE VENTAS_COTOPAXI ADD CONSTRAINT VENTAS_COTOPAXI_PK PRIMARY KEY (VENTA_ID);
ALTER TABLE VENTAS_TUNGURAHUA ADD CONSTRAINT VENTAS_TUNGURAHUA_PK PRIMARY KEY (VENTA_ID);

ALTER TABLE VENTAS_PICHINCHA ADD CONSTRAINT VENTAS_PICHINCHA_FK_CLIENTE FOREIGN KEY (CLIENTE_ID) REFERENCES CLIENTE_PICHINCHA(CLIENTE_ID);
ALTER TABLE VENTAS_COTOPAXI ADD CONSTRAINT VENTAS_COTOPAXI_FK_CLIENTE FOREIGN KEY (CLIENTE_ID) REFERENCES CLIENTE_COTOPAXI(CLIENTE_ID);
ALTER TABLE VENTAS_TUNGURAHUA ADD CONSTRAINT VENTAS_TUNGURAHUA_FK_CLIENTE FOREIGN KEY (CLIENTE_ID) REFERENCES CLIENTE_TUNGURAHUA(CLIENTE_ID);

ALTER TABLE VENTAS_PICHINCHA ADD CONSTRAINT VENTAS_PICHINCHA_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_PICHINCHA(ID_TIENDA);
ALTER TABLE VENTAS_COTOPAXI ADD CONSTRAINT VENTAS_COTOPAXI_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_COTOPAXI(ID_TIENDA);
ALTER TABLE VENTAS_TUNGURAHUA ADD CONSTRAINT VENTAS_TUNGURAHUA_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_TUNGURAHUA(ID_TIENDA);

ALTER TABLE VENTAS_PICHINCHA ADD CONSTRAINT VENTAS_PICHINCHA_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_PICHINCHA));
ALTER TABLE VENTAS_COTOPAXI ADD CONSTRAINT VENTAS_COTOPAXI_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_COTOPAXI));
ALTER TABLE VENTAS_TUNGURAHUA ADD CONSTRAINT VENTAS_TUNGURAHUA_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_TUNGURAHUA));

-- 5. INVENTARIO (fragmentos)
CREATE TABLE INVENTARIO_PICHINCHA AS SELECT * FROM INVENTARIO i JOIN TIENDA t ON i.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_PICHINCHA) WITH NO DATA;
CREATE TABLE INVENTARIO_COTOPAXI AS SELECT * FROM INVENTARIO i JOIN TIENDA t ON i.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_COTOPAXI) WITH NO DATA;
CREATE TABLE INVENTARIO_TUNGURAHUA AS SELECT * FROM INVENTARIO i JOIN TIENDA t ON i.ID_TIENDA = t.ID_TIENDA WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_TUNGURAHUA) WITH NO DATA;

ALTER TABLE INVENTARIO_PICHINCHA ADD CONSTRAINT INVENTARIO_PICHINCHA_PK PRIMARY KEY (INVENTARIO_ID);
ALTER TABLE INVENTARIO_COTOPAXI ADD CONSTRAINT INVENTARIO_COTOPAXI_PK PRIMARY KEY (INVENTARIO_ID);
ALTER TABLE INVENTARIO_TUNGURAHUA ADD CONSTRAINT INVENTARIO_TUNGURAHUA_PK PRIMARY KEY (INVENTARIO_ID);

ALTER TABLE INVENTARIO_PICHINCHA ADD CONSTRAINT INVENTARIO_PICHINCHA_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_PICHINCHA(ID_TIENDA);
ALTER TABLE INVENTARIO_COTOPAXI ADD CONSTRAINT INVENTARIO_COTOPAXI_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_COTOPAXI(ID_TIENDA);
ALTER TABLE INVENTARIO_TUNGURAHUA ADD CONSTRAINT INVENTARIO_TUNGURAHUA_FK_TIENDA FOREIGN KEY (ID_TIENDA) REFERENCES TIENDA_TUNGURAHUA(ID_TIENDA);

ALTER TABLE INVENTARIO_PICHINCHA ADD CONSTRAINT INVENTARIO_PICHINCHA_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_PICHINCHA));
ALTER TABLE INVENTARIO_COTOPAXI ADD CONSTRAINT INVENTARIO_COTOPAXI_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_COTOPAXI));
ALTER TABLE INVENTARIO_TUNGURAHUA ADD CONSTRAINT INVENTARIO_TUNGURAHUA_CK CHECK (ID_TIENDA IN (SELECT ID_TIENDA FROM TIENDA_TUNGURAHUA));

-- 6. DETALLE_VENTA (fragmentos)
CREATE TABLE DETALLE_VENTA_PICHINCHA AS 
SELECT dv.* 
FROM DETALLE_VENTA dv 
JOIN VENTAS v ON dv.VENTA_ID = v.VENTA_ID 
JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA 
WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_PICHINCHA) WITH NO DATA;

CREATE TABLE DETALLE_VENTA_COTOPAXI AS 
SELECT dv.* 
FROM DETALLE_VENTA dv 
JOIN VENTAS v ON dv.VENTA_ID = v.VENTA_ID 
JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA 
WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_COTOPAXI) WITH NO DATA;

CREATE TABLE DETALLE_VENTA_TUNGURAHUA AS 
SELECT dv.* 
FROM DETALLE_VENTA dv 
JOIN VENTAS v ON dv.VENTA_ID = v.VENTA_ID 
JOIN TIENDA t ON v.ID_TIENDA = t.ID_TIENDA 
WHERE t.PROVINCIA_ID IN (SELECT PROVINCIA_ID FROM PROVINCIA_TUNGURAHUA) WITH NO DATA;

ALTER TABLE DETALLE_VENTA_PICHINCHA ADD CONSTRAINT DETALLE_VENTA_PICHINCHA_PK PRIMARY KEY (VENTA_ID, DETALLE_ID);
ALTER TABLE DETALLE_VENTA_COTOPAXI ADD CONSTRAINT DETALLE_VENTA_COTOPAXI_PK PRIMARY KEY (VENTA_ID, DETALLE_ID);
ALTER TABLE DETALLE_VENTA_TUNGURAHUA ADD CONSTRAINT DETALLE_VENTA_TUNGURAHUA_PK PRIMARY KEY (VENTA_ID, DETALLE_ID);

ALTER TABLE DETALLE_VENTA_PICHINCHA ADD CONSTRAINT DETALLE_VENTA_PICHINCHA_FK_VENTAS FOREIGN KEY (VENTA_ID) REFERENCES VENTAS_PICHINCHA(VENTA_ID);
ALTER TABLE DETALLE_VENTA_COTOPAXI ADD CONSTRAINT DETALLE_VENTA_COTOPAXI_FK_VENTAS FOREIGN KEY (VENTA_ID) REFERENCES VENTAS_COTOPAXI(VENTA_ID);
ALTER TABLE DETALLE_VENTA_TUNGURAHUA ADD CONSTRAINT DETALLE_VENTA_TUNGURAHUA_FK_VENTAS FOREIGN KEY (VENTA_ID) REFERENCES VENTAS_TUNGURAHUA(VENTA_ID);

ALTER TABLE DETALLE_VENTA_PICHINCHA ADD CONSTRAINT DETALLE_VENTA_PICHINCHA_FK_PRODUCTO FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTO(PRODUCTO_ID);
ALTER TABLE DETALLE_VENTA_COTOPAXI ADD CONSTRAINT DETALLE_VENTA_COTOPAXI_FK_PRODUCTO FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTO(PRODUCTO_ID);
ALTER TABLE DETALLE_VENTA_TUNGURAHUA ADD CONSTRAINT DETALLE_VENTA_TUNGURAHUA_FK_PRODUCTO FOREIGN KEY (PRODUCTO_ID) REFERENCES PRODUCTO(PRODUCTO_ID);

ALTER TABLE DETALLE_VENTA_PICHINCHA ADD CONSTRAINT DETALLE_VENTA_PICHINCHA_CK CHECK (VENTA_ID IN (SELECT VENTA_ID FROM VENTAS_PICHINCHA));
ALTER TABLE DETALLE_VENTA_COTOPAXI ADD CONSTRAINT DETALLE_VENTA_COTOPAXI_CK CHECK (VENTA_ID IN (SELECT VENTA_ID FROM VENTAS_COTOPAXI));
ALTER TABLE DETALLE_VENTA_TUNGURAHUA ADD CONSTRAINT DETALLE_VENTA_TUNGURAHUA_CK CHECK (VENTA_ID IN (SELECT VENTA_ID FROM VENTAS_TUNGURAHUA));
